<div class="transfers-container">
  <div class="transfers-card">
    <div class="header">
      <h2 tuiTitle size="l">Transfers</h2>
      <div class="header-actions">
        <button
          tuiButton
          type="button"
          appearance="primary"
          size="m"
          (click)="toggleRegisterForm()">
          @if (showRegisterForm) {
            Cancel
          } @else {
            Register Transfer
          }
        </button>
      </div>
    </div>

    <!-- Register Transfer Form -->
    @if (showRegisterForm) {
      <div class="register-form-section">
        <h3 tuiTitle size="m">Register New Transfer</h3>
        <div class="form-grid">
          <div class="form-item">
            <tui-textfield>
              <label tuiLabel>Source Operation ID</label>
              <input
                tuiTextfield
                [(ngModel)]="newTransfer.sourceId"
                type="text"
                placeholder="Enter source operation ID"
              />
            </tui-textfield>
          </div>

          <div class="form-item">
            <tui-textfield>
              <label tuiLabel>Sink Operation ID</label>
              <input
                tuiTextfield
                [(ngModel)]="newTransfer.sinkId"
                type="text"
                placeholder="Enter sink operation ID"
              />
            </tui-textfield>
          </div>

          <div class="form-item">
            <tui-textfield>
              <label tuiLabel>Comment</label>
              <input
                tuiTextfield
                [(ngModel)]="newTransfer.comment"
                type="text"
                placeholder="Enter transfer comment"
              />
            </tui-textfield>
          </div>

          <div class="form-item">
            <tui-textfield tuiChevron>
              <label tuiLabel>Accuracy</label>
              <input
                tuiSelect
                [(ngModel)]="newTransfer.accuracy"
                tuiTextfieldSize="s"
              />
              <tui-data-list-wrapper
                *tuiTextfieldDropdown
                new
                [items]="accuracyOptions"
              />
            </tui-textfield>
          </div>
        </div>

        <div class="form-actions">
          <button
            tuiButton
            type="button"
            appearance="primary"
            size="m"
            [disabled]="isLoading"
            (click)="registerTransfer()">
            Register Transfer
          </button>
          <button
            tuiButton
            type="button"
            appearance="secondary"
            size="m"
            [disabled]="isLoading"
            (click)="toggleRegisterForm()">
            Cancel
          </button>
        </div>
      </div>
    }

    <!-- Filters -->
    <div class="filters-section">
      <h3 tuiTitle size="m">Filters</h3>
      <div class="filters-grid">
        <div class="filter-item">
          <tui-textfield>
            <label tuiLabel>From Date</label>
            <input
              tuiTextfield
              [(ngModel)]="fromDate"
              (ngModelChange)="onDateChange()"
              type="date"
            />
          </tui-textfield>
        </div>

        <div class="filter-item">
          <tui-textfield>
            <label tuiLabel>Till Date</label>
            <input
              tuiTextfield
              [(ngModel)]="tillDate"
              (ngModelChange)="onDateChange()"
              type="date"
            />
          </tui-textfield>
        </div>

        <div class="filter-item">
          <tui-textfield tuiChevron>
            <label tuiLabel>Accuracy</label>
            <input
              tuiSelect
              [(ngModel)]="accuracyFilter"
              (ngModelChange)="onAccuracyChange()"
              tuiTextfieldSize="s"
            />
            <tui-data-list-wrapper
              *tuiTextfieldDropdown
              new
              [items]="accuracyFilterOptions"
            />
          </tui-textfield>
        </div>

        <div class="filter-item filter-actions">
          <button
            tuiButton
            type="button"
            appearance="secondary"
            size="m"
            (click)="resetFilters()">
            Reset Filters
          </button>
        </div>
      </div>
    </div>

    <!-- Transfers List -->
    <div class="transfers-section">
      @if (transfers$ | async; as transfersList) {
        <!-- Recorded Transfers -->
        @if (transfersList.recorded && transfersList.recorded.length > 0) {
          <div class="transfers-group">
            <div class="transfers-group-header">
              <h3 tuiTitle size="m">Recorded Transfers ({{ transfersList.recorded.length }})</h3>
              <button
                tuiButton
                type="button"
                appearance="icon"
                size="s"
                (click)="toggleRecordedTransfers()">
                @if (showRecordedTransfers) {
                  ▼
                } @else {
                  ▶
                }
              </button>
            </div>
            @if (showRecordedTransfers) {
              <app-transfers-table
                [transfers]="transfersList.recorded"
                [showActions]="true"
                [showQuickRegister]="false"
                (transferDeleted)="onDeleteTransfer($event)">
              </app-transfers-table>
            }
          </div>
        }

        <!-- Unregistered Transfers -->
        @if (transfersList.unregistered && transfersList.unregistered.length > 0) {
          <div class="transfers-group">
            <h3 tuiTitle size="m">Unregistered Transfers ({{ transfersList.unregistered.length }})</h3>
            <div class="form-actions">
              <button
                tuiButton
                type="button"
                appearance="primary"
                size="m"
                [disabled]="isLoading || selectedUnregisteredTransfers.length === 0"
                (click)="registerSelectedTransfers()">
                Register Selected ({{ selectedUnregisteredTransfers.length }})
              </button>
            </div>
            <app-transfers-table
              [transfers]="transfersList.unregistered"
              [showActions]="true"
              [showQuickRegister]="true"
              [enableSelection]="true"
              (transferDeleted)="onDeleteTransfer($event)"
              (transferRegistered)="quickRegisterTransfer($event)"
              (selectionChanged)="onUnregisteredSelectionChanged($event)">
            </app-transfers-table>
          </div>
        }

        @if ((!transfersList.recorded || transfersList.recorded.length === 0) &&
             (!transfersList.unregistered || transfersList.unregistered.length === 0)) {
          <div class="empty-state">
            <p>No transfers found.</p>
            <button
              tuiButton
              type="button"
              appearance="primary"
              size="m"
              (click)="toggleRegisterForm()">
              Register Transfer
            </button>
          </div>
        } @else {
          <div class="transfers-count">
            Total: {{ transfersList.recorded.length + transfersList.unregistered.length }} transfer(s)
            ({{ transfersList.recorded.length }} recorded, {{ transfersList.unregistered.length }} unregistered)
          </div>
        }
      } @else {
        <tui-loader [showLoader]="true">
          <div class="loading-placeholder">Loading transfers...</div>
        </tui-loader>
      }
    </div>
  </div>
</div>
