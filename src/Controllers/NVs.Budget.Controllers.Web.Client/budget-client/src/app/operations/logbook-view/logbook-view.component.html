<div class="logbook-container">
  <tui-loader [overlay]="true" [showLoader]="isLoading">
    <div class="logbook-card">
      <div class="header">
      <h2 tuiTitle size="l">Operations Logbook</h2>

      <div class="header-actions">
        <button
          tuiButton
          type="button"
          appearance="secondary"
          size="m"
          (click)="viewOperations()">
          View Operations List
        </button>
      </div>
    </div>

      <div class="filters-section">
        <div class="filters-header">
          <h3 tuiTitle size="m">Filters</h3>
          <button
            tuiButton
            type="button"
            appearance="secondary"
            size="s"
            (click)="showFilters = !showFilters">
            {{ showFilters ? 'Hide Filters' : 'Show Filters' }}
          </button>
        </div>
        @if (showFilters) {
        <div class="additional-parameters">
        <div class="date-range-section">
              <div class="section-header">
                <h4 tuiTitle size="s">Date Range</h4>
                <label class="mode-toggle" tuiLabel>
                  <input
                    tuiCheckbox
                    type="checkbox"
                    [(ngModel)]="useDatePresets"
                  />
                  Use presets
                </label>
              </div>

              @if (!useDatePresets) {
            <div class="date-inputs">
              <div class="date-field">
                <tui-textfield>
                  <label tuiLabel>From Date</label>
                  <input
                    tuiTextfield
                    type="date"
                    [(ngModel)]="fromDate"
                  />
                </tui-textfield>
              </div>

              <div class="date-field">
                <tui-textfield>
                  <label tuiLabel>Till Date</label>
                  <input
                    tuiTextfield
                    type="date"
                    [(ngModel)]="tillDate"
                  />
                </tui-textfield>
              </div>
            </div>
          } @else {
            <div class="preset-buttons">
              <button
                tuiButton
                type="button"
                    [appearance]="selectedDatePreset === 'lastYear' ? 'primary' : 'secondary'"
                size="s"
                (click)="setDateRange('lastYear')">
                Last Year
              </button>
              <button
                tuiButton
                type="button"
                    [appearance]="selectedDatePreset === 'currentYear' ? 'primary' : 'secondary'"
                size="s"
                (click)="setDateRange('currentYear')">
                This Year
              </button>
              <button
                tuiButton
                type="button"
                    [appearance]="selectedDatePreset === 'lastMonth' ? 'primary' : 'secondary'"
                size="s"
                (click)="setDateRange('lastMonth')">
                Last Month
              </button>
              <button
                tuiButton
                type="button"
                    [appearance]="selectedDatePreset === 'currentMonth' ? 'primary' : 'secondary'"
                size="s"
                (click)="setDateRange('currentMonth')">
                This Month
              </button>
            </div>
          }
        </div>

        <div class="cron-section">
              <div class="section-header">
                <h4 tuiTitle size="s">Cron Expression</h4>
                <label class="mode-toggle" tuiLabel>
                  <input
                    tuiCheckbox
                    type="checkbox"
                    [(ngModel)]="useCronPresets"
                  />
                  Use presets
                </label>
              </div>

              @if (!useCronPresets) {
            <div class="cron-field">
              <tui-textfield>
                <label tuiLabel>Cron Expression (optional - to split into periods)</label>
                <input
                  tuiTextfield
                  type="text"
                  [(ngModel)]="cronExpression"
                  placeholder="e.g., 0 0 1 * * for monthly"
                />
              </tui-textfield>
            </div>
          } @else {
            <div class="preset-buttons">
              <button
                tuiButton
                type="button"
                    [appearance]="selectedCronPreset === 'monthly' ? 'primary' : 'secondary'"
                size="s"
                (click)="setCronPreset('monthly')">
                Monthly
              </button>
              <button
                tuiButton
                type="button"
                    [appearance]="selectedCronPreset === 'yearly' ? 'primary' : 'secondary'"
                size="s"
                (click)="setCronPreset('yearly')">
                Yearly
              </button>
            </div>
          }
        </div>
      </div>

        <app-criteria-filter
          [initialCriteria]="currentCriteria"
          [showExamplesInitially]="false"
          (criteriaSubmitted)="onCriteriaSubmitted($event)"
          (criteriaCleared)="onCriteriaCleared()">            
            <div class="currency-section">
              <tui-textfield tuiChevron class="currency-selector">
                <input
                  tuiSelect
                  placeholder="Output Currency"
                  tuiTextfieldSize="s"
                  [(ngModel)]="outputCurrency"
                />
                <tui-data-list-wrapper
                  *tuiTextfieldDropdown
                  new
                  [items]="items"
                />
              </tui-textfield>
            </div>

        </app-criteria-filter>
        }
      </div>

      @if (logbook) {
        <div class="logbook-section">
          <div class="header">
            <h3 tuiTitle size="m">Logbook Statistics</h3>
            <div class="header-actions">
              <label class="mode-toggle" tuiLabel>
                <input
                  tuiCheckbox
                  type="checkbox"
                  [(ngModel)]="showRelative"
                />
                Relative (%)
              </label>
              @if (showRelative) {
                <label class="mode-toggle" tuiLabel>
                  <input
                    tuiCheckbox
                    type="checkbox"
                    [(ngModel)]="invertRelative"
                  />
                  Invert sign
                </label>
                <label class="mode-toggle" tuiLabel>
                  <input
                    tuiCheckbox
                    type="checkbox"
                    [(ngModel)]="highlightRelative"
                  />
                  Highlight changes
                </label>
              }
              <button
                tuiButton
                type="button"
                appearance="secondary"
                size="m"
                (click)="toggleExpandAll()">
                {{ isAllExpanded ? 'Collapse All' : 'Expand All' }}
              </button>
              <button
                tuiButton
                type="button"
                appearance="secondary"
                size="m"
                [disabled]="!hasActiveSorts"
                (click)="resetSorting()">
                Reset Sorting
              </button>
            </div>
          </div>

          @if (criteriaRows.length > 0 && ranges.length > 0) {
            <div class="logbook-table-container">
              <table class="logbook-table">
                <thead>
                  <tr>
                    <th class="criteria-column">Category</th>
                    @for (range of ranges; track range.name) {
                      <th class="range-column" [title]="(range.from | dateFormat) + ' - ' + (range.till | dateFormat)">
                        <div class="range-header">
                          <span>{{ range.name }}</span>
                          @if (getRangeSortIndicator(range.name)) {
                            <span class="range-sort-indicator">
                              {{ getRangeSortIndicator(range.name) }}
                            </span>
                          }
                        </div>
                      </th>
                    }
                  </tr>
                </thead>
                <tbody>
                  @for (row of criteriaRows; track row.path) {
                    @if (isRowVisible(row)) {
                      <tr class="criteria-row" [class.has-children]="row.hasChildren" [attr.data-level]="row.level">
                        <td class="criteria-cell" [style.padding-left.rem]="row.level * 2">
                          <div class="criteria-info">
                            @if (row.hasChildren) {
                              <span class="expand-icon" (click)="toggleRow(row.path)">
                                {{ isRowExpanded(row.path) ? '▼' : '▶' }}
                              </span>
                            } @else {
                              <span class="expand-icon placeholder"></span>
                            }
                            <span class="criteria-name">{{ row.description }}</span>
                            @if (getRowSortIndicator(row)) {
                              <span class="group-sort-indicator">
                                {{ getRowSortIndicator(row) }}
                              </span>
                            }
                          </div>
                        </td>
                        @for (range of ranges; track range.name) {
                          <td class="data-cell"
                              [class.clickable]="hasOperationsInRange(row, range.name)"
                              [title]="hasOperationsInRange(row, range.name) ? 'Click to view ' + getEntryForRange(row, range.name)?.operationsCount + ' operations' : ''"
                              (click)="hasOperationsInRange(row, range.name) && viewGroupOperations(row, range.name, $event)">
                            <div class="data-cell-content">
                              @if (row.hasChildren) {
                                <button
                                  class="group-sort-toggle"
                                  type="button"
                                  (click)="toggleGroupSort(row, range.name, $event)">
                                  {{ getGroupSortIndicator(row, range.name) }}
                                </button>
                              }
                              @if (getEntryForRange(row, range.name); as entry) {
                                @if (!showRelative) {
                                  @if (entry.sum.value !== 0) {
                                    <div class="sum-value"
                                         [class.positive]="entry.sum.value > 0"
                                         [class.negative]="entry.sum.value < 0">
                                      {{ entry.sum.value | currencyFormat }}
                                    </div>
                                  } @else {
                                    <div class="empty-cell">-</div>
                                  }
                                } @else {
                                  @if (getRelativeChangeInfo(row, range.name); as relativeChange) {
                                    @if (relativeChange.value !== null) {
                                      <div class="sum-value relative-value"
                                           [class.base-value]="relativeChange.display === 'base'"
                                           [class.positive]="highlightRelative && relativeChange.value > 0"
                                           [class.negative]="highlightRelative && relativeChange.value < 0">
                                        {{ relativeChange.display }}
                                      </div>
                                    } @else {
                                      <div class="empty-cell">-</div>
                                    }
                                  }
                                }
                              } @else {
                                <div class="empty-cell">-</div>
                              }
                            </div>
                          </td>
                        }
                    }
                  }
                </tbody>
              </table>
            </div>
          } @else {
            <div class="empty-state">
              <p>No logbook data available for the selected criteria and date range.</p>
            </div>
          }

          @if (logbook.errors.length > 0) {
            <div class="logbook-errors">
              <h4 tuiTitle size="s">Errors ({{ logbook.errors.length }})</h4>
              <div class="error-list">
                @for (error of logbook.errors; track $index) {
                  <div class="error-item">
                    <div class="error-message">
                      <strong>{{ error.message || 'Unknown error' }}</strong>
                    </div>

                    @if (hasMetadata(error)) {
                      <div class="error-metadata">
                        <div class="metadata-label">Metadata:</div>
                        <div class="metadata-content">
                          @for (key of getMetadataKeys(error.metadata!); track key) {
                            <div class="metadata-item">
                              <span class="metadata-key">{{ key }}:</span>
                              <span class="metadata-value">{{ formatMetadataValue(error.metadata![key]) }}</span>
                            </div>
                          }
                        </div>
                      </div>
                    }

                    @if (hasNestedReasons(error)) {
                      <div class="nested-reasons">
                        <div class="nested-label">Nested Reasons:</div>
                        <div class="nested-content">
                          @for (reason of error.reasons; track $index) {
                            <div class="nested-reason">
                              {{ reason.message || 'No message' }}
                              @if (hasMetadata(reason)) {
                                <div class="reason-metadata">
                                  @for (key of getMetadataKeys(reason.metadata!); track key) {
                                    <div class="metadata-item small">
                                      <span class="metadata-key">{{ key }}:</span>
                                      <span class="metadata-value">{{ formatMetadataValue(reason.metadata![key]) }}</span>
                                    </div>
                                  }
                                </div>
                              }
                            </div>
                          }
                        </div>
                      </div>
                    }
                  </div>
                }
              </div>
            </div>
          }
        </div>
      }
    </div>
  </tui-loader>
</div>
