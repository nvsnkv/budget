<div class="operations-table-container">
  <table class="operations-table">
    <thead>
      <tr>
        <th class="col-timestamp">
          <button
            type="button"
            class="column-sort"
            (click)="toggleSort('timestamp')">
            Date & Time
            <span class="sort-indicator">{{ getSortIndicator('timestamp') }}</span>
          </button>
        </th>
        <th class="col-description">
          <button
            type="button"
            class="column-sort"
            (click)="toggleSort('description')">
            Description
            <span class="sort-indicator">{{ getSortIndicator('description') }}</span>
          </button>
        </th>
        <th class="col-amount">
          <button
            type="button"
            class="column-sort"
            (click)="toggleSort('amount')">
            Amount
            <span class="sort-indicator">{{ getSortIndicator('amount') }}</span>
          </button>
        </th>
        <th class="col-tags">Tags</th>
        <th class="col-attributes">Attributes</th>
        @if (showActions) {
          <th class="col-actions">Actions</th>
        }
      </tr>
    </thead>
    <tbody>
      @for (operation of displayedOperations; track operation.id) {
        <tr class="operation-row" [class.editing]="isEditing(operation.id)" [class.deleting]="isDeleting(operation.id)">
          <td class="col-timestamp">{{ operation.timestamp | dateFormat }}</td>
          <td class="col-description">
            @if (isEditing(operation.id)) {
              <div class="description-edit">
                <input 
                  class="edit-input" 
                  [(ngModel)]="editingOperations[operation.id].description"
                  placeholder="Description"
                />
                <input 
                  class="edit-input notes-input"
                  [(ngModel)]="editingOperations[operation.id].notes"
                  placeholder="Notes"
                />
              </div>
            } @else {
              <div class="description-content">
                <div class="description-text">{{ operation.description }}</div>
                @if (noteEditingId === operation.id) {
                  <div class="notes-inline">
                    <input
                      class="notes-input"
                      [(ngModel)]="noteDrafts[operation.id]"
                      (blur)="onNoteBlur(operation)"
                      (keydown.enter)="onNoteEnter(operation, $event)"
                      placeholder="Notes"
                      autofocus
                    />
                    <span class="note-status" [attr.data-status]="noteSaveStatus[operation.id] || 'idle'">
                      @if (noteSaveStatus[operation.id] === 'saved') {
                        ‚úî
                      } @else if (noteSaveStatus[operation.id] === 'error') {
                        ‚úñ
                      } @else if (noteSaveStatus[operation.id] === 'saving') {
                        ‚Ä¶
                      }
                    </span>
                  </div>
                } @else {
                  <div class="notes-inline notes-display" (click)="startNoteEdit(operation)">
                    <span class="notes-text" [class.empty]="!operation.notes">
                      {{ operation.notes || 'Add note' }}
                    </span>
                    <button
                      tuiButton
                      type="button"
                      appearance="icon"
                      size="xs"
                      class="notes-edit-button"
                      (click)="startNoteEdit(operation); $event.stopPropagation()">
                      ‚úèÔ∏è
                    </button>
                    <span class="note-status" [attr.data-status]="noteSaveStatus[operation.id] || 'idle'">
                      @if (noteSaveStatus[operation.id] === 'saved') {
                        ‚úî
                      } @else if (noteSaveStatus[operation.id] === 'error') {
                        ‚úñ
                      } @else if (noteSaveStatus[operation.id] === 'saving') {
                        ‚Ä¶
                      }
                    </span>
                  </div>
                }
              </div>
            }
          </td>
          <td class="col-amount" [class.positive]="operation.amount.value > 0" [class.negative]="operation.amount.value < 0">
            @if (isEditing(operation.id)) {
              <div class="amount-edit">
                <input 
                  class="edit-input amount-input" 
                  type="number" 
                  [(ngModel)]="editingOperations[operation.id].amount"
                  step="0.01"
                />
                <input 
                  class="edit-input currency-input" 
                  [(ngModel)]="editingOperations[operation.id].currencyCode"
                  placeholder="USD"
                  maxlength="3"
                />
              </div>
            } @else {
              {{ operation.amount.value | currencyFormat: operation.amount.currencyCode }}
            }
          </td>
          <td class="col-tags">
            @if (isEditing(operation.id)) {
              <div class="tags-edit">
                @for (tag of editingOperations[operation.id].tags; track trackByIndex($index); let i = $index) {
                  <div class="tag-edit-item">
                    <input 
                      class="edit-input tag-input" 
                      [(ngModel)]="editingOperations[operation.id].tags[i]"
                      placeholder="tag"
                    />
                    <button 
                      tuiButton
                      type="button"
                      appearance="icon"
                      size="xs"
                      (click)="removeTag(operation.id, i)">
                      ‚úï
                    </button>
                  </div>
                }
                <button 
                  tuiButton
                  type="button"
                  appearance="flat"
                  size="xs"
                  (click)="addTag(operation.id)">
                  + Add Tag
                </button>
              </div>
            } @else {
              <div class="tags-inline">
                @for (tag of operation.tags; track tag) {
                  <tui-chip size="xs">{{ tag }}</tui-chip>
                }
              </div>
            }
          </td>
          <td class="col-attributes">
            @if (isEditing(operation.id)) {
              <div class="attributes-edit">
                @for (key of editingOperations[operation.id].attributes | objectKeys; track key) {
                  <div class="attribute-edit-item">
                    <input 
                      class="edit-input attr-key-input" 
                      [value]="key"
                      (blur)="updateAttributeKey(operation.id, key, $any($event.target).value)"
                      placeholder="key"
                    />
                    <input 
                      class="edit-input attr-value-input" 
                      [(ngModel)]="editingOperations[operation.id].attributes[key]"
                      placeholder="value"
                    />
                    <button 
                      tuiButton
                      type="button"
                      appearance="icon"
                      size="xs"
                      (click)="removeAttribute(operation.id, key)">
                      ‚úï
                    </button>
                  </div>
                }
                <button 
                  tuiButton
                  type="button"
                  appearance="flat"
                  size="xs"
                  (click)="addAttribute(operation.id)">
                  + Add Attribute
                </button>
              </div>
            } @else {
              @if (operation.attributes && (operation.attributes | objectKeys).length > 0) {
                <div class="attributes-inline">
                  @for (key of operation.attributes | objectKeys; track key) {
                    <tui-chip size="xs" class="attr-chip">
                      {{ key }}: {{ operation.attributes![key] }}
                    </tui-chip>
                  }
                </div>
              } @else {
                <span class="no-attributes">‚Äî</span>
              }
            }
          </td>
          @if (showActions) {
            <td class="col-actions">
              @if (isEditing(operation.id)) {
                <div class="actions-buttons edit-mode">
                  <button 
                    tuiButton
                    type="button"
                    appearance="secondary"
                    size="xs"
                    (click)="cancelEdit(operation.id)">
                    ‚úï
                  </button>
                </div>
              } @else {
                <div class="actions-buttons">
                  <button 
                    tuiButton
                    type="button"
                    appearance="flat"
                    size="xs"
                    (click)="toggleOperationDetails(operation.id)">
                    {{ expandedOperationId === operation.id ? '‚ñº' : '‚ñ∂' }}
                  </button>
                  <button 
                    tuiButton
                    type="button"
                    appearance="icon"
                    size="xs"
                    title="Edit operation"
                    [disabled]="isDeleting(operation.id)"
                    (click)="startEdit(operation)">
                    ‚úèÔ∏è
                  </button>
                  <button 
                    tuiButton
                    type="button"
                    appearance="icon"
                    size="xs"
                    [class.delete-marked]="isDeleting(operation.id)"
                    [disabled]="isEditing(operation.id)"
                    [title]="isDeleting(operation.id) ? 'Undo delete' : 'Mark for delete'"
                    (click)="toggleDelete(operation)">
                    {{ isDeleting(operation.id) ? '‚Ü©' : 'üóëÔ∏è' }}
                  </button>
                </div>
              }
            </td>
          }
        </tr>
        
        @if (expandedOperationId === operation.id) {
          <tr class="operation-details-row">
            <td [attr.colspan]="showActions ? 6 : 5">
              <tui-expand [expanded]="true">
                <div class="operation-details">
                  <div class="detail-row">
                    <span class="detail-label">Operation ID:</span>
                    <span class="detail-value"><code>{{ operation.id }}</code></span>
                  </div>
                  <div class="detail-row">
                    <span class="detail-label">Budget ID:</span>
                    <span class="detail-value"><code>{{ operation.budgetId }}</code></span>
                  </div>
                  <div class="detail-row">
                    <span class="detail-label">Version:</span>
                    <span class="detail-value"><code>{{ operation.version }}</code></span>
                  </div>
                </div>
              </tui-expand>
            </td>
          </tr>
        }
      }
    </tbody>
    @if (showActions) {
      <tfoot>
        <tr class="operations-footer-row">
          <td [attr.colspan]="6">
            <div class="table-footer-actions">
              <label class="edited-only-toggle">
                <input
                  type="checkbox"
                  [checked]="showChangedOnly"
                  (change)="toggleShowChangedOnly()"
                />
                Show changed only
              </label>
              @if (pendingEditsCount > 0) {
                <span class="edited-count">
                  {{ pendingEditsCount }} edited
                </span>
              }
              @if (pendingDeletesCount > 0) {
                <span class="deleted-count">
                  {{ pendingDeletesCount }} deleted
                </span>
              }
              @if (hasPendingEdits) {
                <button
                  tuiButton
                  type="button"
                  appearance="primary"
                  size="s"
                  (click)="saveAllEdits()">
                  Save all
                </button>
              }
              @if (hasPendingDeletes) {
                <button
                  tuiButton
                  type="button"
                  appearance="destructive"
                  size="s"
                  (click)="deleteAllMarked()">
                  Delete marked
                </button>
              }
            </div>
          </td>
        </tr>
      </tfoot>
    }
  </table>
</div>

