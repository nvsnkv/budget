<div class="operations-container">
  <div tuiCardLarge class="operations-card">
    <div class="header">
      <h2 tuiTitle size="l">Operations</h2>
      <div class="header-actions">
        <button 
          tuiButton
          type="button"
          appearance="primary"
          size="m"
          (click)="navigateToImport()">
          Import Operations
        </button>
        <button 
          tuiButton
          type="button"
          appearance="secondary"
          size="m"
          (click)="navigateToBudget()">
          Back to Budget
        </button>
      </div>
    </div>

    @if (budget) {
      <div class="budget-info">
        <p><strong>Budget:</strong> {{ budget.name }}</p>
      </div>
    }

    <!-- Filters -->
    <form [formGroup]="filterForm" class="filters-section">
      <h3 tuiTitle size="m">Filters</h3>
      <div class="filters-grid">
        <tui-textfield>
          <label tuiLabel>Criteria Expression</label>
          <input 
            tuiTextfield 
            formControlName="criteria" 
            type="text" 
            placeholder="e.g., o => o.Amount.Amount > 100"
          />
        </tui-textfield>
        
        <tui-textfield>
          <label tuiLabel>Output Currency</label>
          <input 
            tuiTextfield 
            formControlName="outputCurrency" 
            type="text" 
            placeholder="e.g., USD, EUR"
          />
        </tui-textfield>
        
        <div class="checkbox-field">
          <label>
            <input type="checkbox" formControlName="excludeTransfers" />
            Exclude Transfers
          </label>
        </div>
      </div>
      
      <div class="filter-actions">
        <button 
          tuiButton
          type="button"
          appearance="primary"
          size="s"
          (click)="applyFilters()">
          Apply Filters
        </button>
        <button 
          tuiButton
          type="button"
          appearance="flat"
          size="s"
          (click)="clearFilters()">
          Clear
        </button>
      </div>
    </form>

    <!-- Delete Operations Section -->
    <div class="delete-section">
      <div class="delete-header">
        <h3 tuiTitle size="m">Delete Operations</h3>
        <button 
          tuiButton
          type="button"
          appearance="flat"
          size="s"
          (click)="toggleDeleteSection()">
          {{ showDeleteSection ? '▼ Hide' : '▶ Show Delete Options' }}
        </button>
      </div>
      
      @if (showDeleteSection) {
        <form [formGroup]="deleteForm" class="delete-form">
          <div class="warning-message">
            <strong>⚠️ Warning:</strong> This will permanently delete all operations matching the specified criteria.
          </div>
          
          <tui-textfield>
            <label tuiLabel>Criteria Expression</label>
            <textarea 
              tuiTextarea 
              formControlName="criteria" 
              rows="3"
              placeholder="e.g., o => o.Amount.Amount < 0 && o.Tags.Contains('unwanted')"
            ></textarea>
          </tui-textfield>
          
          <p class="help-text">
            Enter a boolean expression to filter operations for deletion. 
            Examples:
            <br>• <code>o => o.Amount.Amount &lt; 0</code> - All negative amounts
            <br>• <code>o => o.Description.Contains("test")</code> - Contains "test"
            <br>• <code>o => o.Timestamp.Year == 2023</code> - From year 2023
          </p>
          
          <div class="delete-actions">
            <button 
              tuiButton
              type="button"
              appearance="destructive"
              size="m"
              [disabled]="!deleteForm.valid || isLoading"
              (click)="deleteOperations()">
              Delete Matching Operations
            </button>
            <button 
              tuiButton
              type="button"
              appearance="flat"
              size="m"
              (click)="toggleDeleteSection()">
              Cancel
            </button>
          </div>
        </form>
      }
    </div>

    <!-- Operations List -->
    <div class="operations-section">
      @if (operations$ | async; as operations) {
        @if (operations.length > 0) {
          <div class="operations-list">
            @for (operation of operations; track operation.id) {
              <div class="operation-card">
                <div class="operation-header" (click)="toggleOperationDetails(operation.id)">
                  <div class="operation-main">
                    <span class="operation-date">{{ formatDate(operation.timestamp) }}</span>
                    <span class="operation-description">{{ operation.description }}</span>
                  </div>
                  <div class="operation-amount" [class.positive]="operation.amount.value > 0" [class.negative]="operation.amount.value < 0">
                    {{ formatCurrency(operation.amount.value, operation.amount.currencyCode) }}
                  </div>
                  <button 
                    tuiButton
                    type="button"
                    appearance="flat"
                    size="xs">
                    {{ expandedOperationId === operation.id ? '▼' : '▶' }}
                  </button>
                </div>
                
                @if (expandedOperationId === operation.id) {
                  <div class="operation-details">
                    <div class="detail-row">
                      <span class="detail-label">ID:</span>
                      <code class="detail-value">{{ operation.id }}</code>
                    </div>
                    <div class="detail-row">
                      <span class="detail-label">Version:</span>
                      <code class="detail-value">{{ operation.version }}</code>
                    </div>
                    <div class="detail-row">
                      <span class="detail-label">Budget ID:</span>
                      <code class="detail-value">{{ operation.budgetId }}</code>
                    </div>
                    
                    @if (operation.tags.length > 0) {
                      <div class="detail-row">
                        <span class="detail-label">Tags:</span>
                        <div class="tags-list">
                          @for (tag of operation.tags; track tag) {
                            <tui-chip size="s">{{ tag }}</tui-chip>
                          }
                        </div>
                      </div>
                    }
                    
                    @if (operation.attributes && getObjectKeys(operation.attributes).length > 0) {
                      <div class="detail-row">
                        <span class="detail-label">Attributes:</span>
                        <div class="attributes-list">
                          @for (key of getObjectKeys(operation.attributes!); track key) {
                            <div class="attribute-item">
                              <span class="attr-key">{{ key }}:</span>
                              <span class="attr-value">{{ operation.attributes![key] }}</span>
                            </div>
                          }
                        </div>
                      </div>
                    }
                  </div>
                }
              </div>
            }
          </div>
          
          <div class="operations-count">
            Total: {{ operations.length }} operations
          </div>
        } @else {
          <div class="empty-state">
            <p>No operations found.</p>
            <button 
              tuiButton
              type="button"
              appearance="primary"
              size="m"
              (click)="navigateToImport()">
              Import Operations
            </button>
          </div>
        }
      } @else {
        <tui-loader [showLoader]="true">
          <div class="loading-placeholder">Loading operations...</div>
        </tui-loader>
      }
    </div>
  </div>
</div>

