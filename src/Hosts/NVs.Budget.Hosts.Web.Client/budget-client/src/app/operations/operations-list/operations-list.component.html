<div class="operations-container">
  <div tuiCardLarge class="operations-card">
    <div class="header">
      <h2 tuiTitle size="l">Operations</h2>
      <div class="header-actions">
        <button 
          tuiButton
          type="button"
          appearance="primary"
          size="m"
          (click)="navigateToImport()">
          Import Operations
        </button>
        <button 
          tuiButton
          type="button"
          appearance="destructive"
          size="m"
          (click)="navigateToDelete()">
          Delete Operations
        </button>
        <button 
          tuiButton
          type="button"
          appearance="secondary"
          size="m"
          (click)="navigateToBudget()">
          Back to Budget
        </button>
      </div>
    </div>

    @if (budget) {
      <div class="budget-info">
        <p><strong>Budget:</strong> {{ budget.name }}</p>
      </div>
    }

    <!-- Filters -->
    <form [formGroup]="filterForm" class="filters-section" (submit)="applyFilters(); $event.preventDefault()">
      <h3 tuiTitle size="m">Filters</h3>
      <div class="filters-grid">
        <div class="filter-item full-width">
          <tui-textfield>
            <label tuiLabel>Criteria Expression (Ctrl+Enter to apply)</label>
            <textarea 
              tuiTextarea 
              formControlName="criteria" 
              rows="2"
              placeholder="e.g., o => o.Amount.Amount > 100"
              (keydown)="onCriteriaKeydown($event)"
            ></textarea>
          </tui-textfield>
        </div>
        
        <div class="filter-item">
          <tui-textfield>
            <label tuiLabel>Output Currency</label>
            <select 
              tuiTextfield
              formControlName="outputCurrency">
              <option value="">-- Original --</option>
              @for (currency of currencies; track currency) {
                <option [value]="currency">{{ currency }}</option>
              }
            </select>
          </tui-textfield>
        </div>
        
        <div class="filter-item checkbox-field">
          <label tuiLabel size="m">
            <input 
              tuiCheckbox
              type="checkbox" 
              formControlName="excludeTransfers"
            />
            Exclude Transfers
          </label>
        </div>
      </div>
      
      <div class="filter-actions">
        <button 
          tuiButton
          type="button"
          appearance="primary"
          size="s"
          (click)="applyFilters()">
          Apply Filters
        </button>
        <button 
          tuiButton
          type="button"
          appearance="flat"
          size="s"
          (click)="clearFilters()">
          Clear
        </button>
      </div>
    </form>

    <!-- Operations List -->
    <div class="operations-section">
      @if (operations$ | async; as operations) {
        @if (operations.length > 0) {
          <div class="operations-table-container">
            <table class="operations-table">
              <thead>
                <tr>
                  <th class="col-timestamp">Date & Time</th>
                  <th class="col-description">Description</th>
                  <th class="col-amount">Amount</th>
                  <th class="col-tags">Tags</th>
                  <th class="col-attributes">Attributes</th>
                  <th class="col-actions">Actions</th>
                </tr>
              </thead>
              <tbody>
                @for (operation of operations; track operation.id) {
                  <tr class="operation-row">
                    <td class="col-timestamp">{{ formatDate(operation.timestamp) }}</td>
                    <td class="col-description">{{ operation.description }}</td>
                    <td class="col-amount" [class.positive]="operation.amount.value > 0" [class.negative]="operation.amount.value < 0">
                      {{ formatCurrency(operation.amount.value, operation.amount.currencyCode) }}
                    </td>
                    <td class="col-tags">
                      <div class="tags-inline">
                        @for (tag of operation.tags; track tag) {
                          <tui-chip size="xs">{{ tag }}</tui-chip>
                        }
                      </div>
                    </td>
                    <td class="col-attributes">
                      @if (operation.attributes && getObjectKeys(operation.attributes).length > 0) {
                        <div class="attributes-inline">
                          @for (key of getObjectKeys(operation.attributes!); track key) {
                            <tui-chip size="xs" class="attr-chip">
                              {{ key }}: {{ operation.attributes![key] }}
                            </tui-chip>
                          }
                        </div>
                      } @else {
                        <span class="no-attributes">—</span>
                      }
                    </td>
                    <td class="col-actions">
                      <button 
                        tuiButton
                        type="button"
                        appearance="flat"
                        size="xs"
                        (click)="toggleOperationDetails(operation.id)">
                        {{ expandedOperationId === operation.id ? '▼' : '▶' }}
                      </button>
                    </td>
                  </tr>
                  
                  @if (expandedOperationId === operation.id) {
                    <tr class="operation-details-row">
                      <td colspan="6">
                        <div class="operation-details">
                          <div class="details-grid">
                            <div class="detail-item">
                              <span class="detail-label">Operation ID:</span>
                              <code class="detail-value">{{ operation.id }}</code>
                            </div>
                            <div class="detail-item">
                              <span class="detail-label">Version:</span>
                              <code class="detail-value">{{ operation.version }}</code>
                            </div>
                            <div class="detail-item">
                              <span class="detail-label">Budget ID:</span>
                              <code class="detail-value">{{ operation.budgetId }}</code>
                            </div>
                          </div>
                        </div>
                      </td>
                    </tr>
                  }
                }
              </tbody>
            </table>
          </div>
          
          <div class="operations-count">
            Total: {{ operations.length }} operations
          </div>
        } @else {
          <div class="empty-state">
            <p>No operations found.</p>
            <button 
              tuiButton
              type="button"
              appearance="primary"
              size="m"
              (click)="navigateToImport()">
              Import Operations
            </button>
          </div>
        }
      } @else {
        <tui-loader [showLoader]="true">
          <div class="loading-placeholder">Loading operations...</div>
        </tui-loader>
      }
    </div>
  </div>
</div>

