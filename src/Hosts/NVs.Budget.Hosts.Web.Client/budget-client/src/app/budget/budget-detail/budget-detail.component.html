<div class="budget-detail-container">
  @if (budget$ | async; as budget) {
    <tui-loader [overlay]="true" [showLoader]="isLoading">
      <div tuiCardLarge class="budget-card">
        <!-- Header with title and actions -->
        <h2 tuiTitle size="l">{{ budget.name }}</h2>
        <div class="header-actions">
          @if (!isEditMode) {
            <button 
              tuiButton
              type="button"
              appearance="primary"
              size="m"
              (click)="toggleEditMode()">
              Edit Budget
            </button>
            <button 
              tuiButton
              type="button"
              appearance="secondary"
              size="m"
              (click)="downloadYaml()">
              Download YAML
            </button>
            <button 
              tuiButton
              type="button"
              appearance="secondary"
              size="m"
              (click)="uploadYaml()">
              Upload YAML
            </button>
            <button 
              tuiButton
              type="button"
              appearance="destructive"
              size="m"
              (click)="deleteBudget()">
              Delete
            </button>
          }
        </div>

        <!-- Budget Info -->
        <div class="budget-info-section">
          <div class="info-grid">
            <div class="info-item">
              <label class="info-label">Budget ID:</label>
              <code class="info-value">{{ budget.id }}</code>
            </div>
            <div class="info-item">
              <label class="info-label">Version:</label>
              <code class="info-value">{{ budget.version }}</code>
            </div>
          </div>

          <!-- Owners -->
          <div class="owners-section">
            <h3 tuiTitle size="m">Owners</h3>
            <div class="owners-list">
                @for (owner of budget.owners; track owner.id) {
                <tui-chip size="m">
                  {{ owner.name }}
                </tui-chip>
              }
            </div>
          </div>
        </div>

        <!-- Edit Form -->
        @if (isEditMode && budgetForm) {
          <form [formGroup]="budgetForm" class="budget-form">
            <!-- Budget Name -->
            <div class="form-section">
              <h3 tuiTitle size="m">Basic Information</h3>
              <tui-textfield>
                <label tuiLabel>Budget Name</label>
                <input tuiTextfield formControlName="name" type="text" />
              </tui-textfield>
            </div>

            <!-- Tagging Criteria -->
            <div class="form-section">
              <div class="section-header">
                <h3 tuiTitle size="m">Tagging Criteria</h3>
                <button 
                  tuiButton
                  type="button"
                  appearance="secondary"
                  size="s"
                  (click)="addTaggingCriterion()">
                  + Add Criterion
                </button>
              </div>
              
              <tui-accordion>
                <div formArrayName="taggingCriteria">
                  @for (criterion of taggingCriteria.controls; track $index; let i = $index) {
                    <tui-accordion-item [formGroupName]="i">
                      <header>
                        <span>Tagging Criterion {{ i + 1 }}</span>
                        <button 
                          tuiButton
                          type="button"
                          appearance="destructive"
                          size="xs"
                          (click)="removeTaggingCriterion(i)">
                          Remove
                        </button>
                      </header>
                      
                      <div class="criterion-fields">
                        <tui-textfield>
                          <label tuiLabel>Tag Expression</label>
                          <textarea tuiTextarea formControlName="tag" rows="2"></textarea>
                        </tui-textfield>
                        
                        <tui-textfield>
                          <label tuiLabel>Condition Expression</label>
                          <textarea tuiTextarea formControlName="condition" rows="2"></textarea>
                        </tui-textfield>
                      </div>
                    </tui-accordion-item>
                  }
                </div>
              </tui-accordion>
            </div>

            <!-- Transfer Criteria -->
            <div class="form-section">
              <div class="section-header">
                <h3 tuiTitle size="m">Transfer Criteria</h3>
                <button 
                  tuiButton
                  type="button"
                  appearance="secondary"
                  size="s"
                  (click)="addTransferCriterion()">
                  + Add Criterion
                </button>
              </div>
              
              <tui-accordion>
                <div formArrayName="transferCriteria">
                  @for (criterion of transferCriteria.controls; track $index; let i = $index) {
                    <tui-accordion-item [formGroupName]="i">
                      <header>
                        <span>Transfer Criterion {{ i + 1 }}</span>
                        <button 
                          tuiButton
                          type="button"
                          appearance="destructive"
                          size="xs"
                          (click)="removeTransferCriterion(i)">
                          Remove
                        </button>
                      </header>
                      
                      <div class="criterion-fields">
                        <tui-textfield>
                          <label tuiLabel>Accuracy (Exact or Likely)</label>
                          <input tuiTextfield formControlName="accuracy" type="text" />
                        </tui-textfield>
                        
                        <tui-textfield>
                          <label tuiLabel>Comment</label>
                          <input tuiTextfield formControlName="comment" type="text" />
                        </tui-textfield>
                        
                        <tui-textfield>
                          <label tuiLabel>Criterion Expression</label>
                          <textarea tuiTextarea formControlName="criterion" rows="3"></textarea>
                        </tui-textfield>
                      </div>
                    </tui-accordion-item>
                  }
                </div>
              </tui-accordion>
            </div>

            <!-- Logbook Criteria -->
            <div class="form-section" [formGroup]="logbookCriteria">
              <h3 tuiTitle size="m">Logbook Criteria</h3>
              
              <div class="logbook-fields">
                <tui-textfield>
                  <label tuiLabel>Description</label>
                  <input tuiTextfield formControlName="description" type="text" placeholder="Criteria description" />
                </tui-textfield>

                <div class="radio-group">
                  <label class="radio-label">Criteria Type:</label>
                  <div class="radio-options">
                    <label class="radio-option">
                      <input type="radio" formControlName="criteriaType" value="universal" />
                      Universal (matches all operations)
                    </label>
                    <label class="radio-option">
                      <input type="radio" formControlName="criteriaType" value="tag-based" />
                      Tag-Based
                    </label>
                    <label class="radio-option">
                      <input type="radio" formControlName="criteriaType" value="criteria-based" />
                      Criteria-Based (expression)
                    </label>
                  </div>
                </div>

                <!-- Tag-Based Fields -->
                @if (logbookCriteria.get('criteriaType')?.value === 'tag-based') {
                  <div class="select-field">
                    <label class="select-label">Type</label>
                    <select class="tui-select" formControlName="type">
                      <option value="">Select type...</option>
                      @for (typeOption of tagBasedCriterionTypes; track typeOption) {
                        <option [value]="typeOption">{{ typeOption }}</option>
                      }
                    </select>
                  </div>

                  <tui-textfield>
                    <label tuiLabel>Tags (comma-separated)</label>
                    <input tuiTextfield formControlName="tags" type="text" placeholder="Tag1, Tag2, Tag3" />
                  </tui-textfield>
                }

                <!-- Criteria-Based Fields -->
                @if (logbookCriteria.get('criteriaType')?.value === 'criteria-based') {
                  <tui-textfield>
                    <label tuiLabel>Criteria Expression</label>
                    <textarea tuiTextarea formControlName="criteria" rows="3" placeholder="e.g., o => o.Amount.Amount > 0"></textarea>
                  </tui-textfield>
                }

                <!-- Substitution (available for all types) -->
                @if (logbookCriteria.get('criteriaType')?.value !== 'universal') {
                  <tui-textfield>
                    <label tuiLabel>Substitution Expression (Optional)</label>
                    <textarea tuiTextarea formControlName="substitution" rows="2" placeholder="e.g., o => o.Description"></textarea>
                  </tui-textfield>
                }

                <!-- Subcriteria -->
                <div class="subcriteria-section">
                  <h4 tuiTitle size="s">Subcriteria</h4>
                  <button 
                    tuiButton
                    type="button"
                    appearance="flat"
                    size="s"
                    (click)="addSubcriterion(logbookCriteria)">
                    + Add Subcriterion
                  </button>
                  
                  @for (subcriterion of getSubcriteria(logbookCriteria).controls; track $index; let idx = $index) {
                    <div class="subcriterion-card">
                      <div class="subcriterion-header">
                        <span>Subcriterion {{ idx + 1 }}</span>
                        <button 
                          tuiButton
                          type="button"
                          appearance="flat"
                          size="xs"
                          (click)="removeSubcriterion(logbookCriteria, idx)">
                          Remove
                        </button>
                      </div>
                      
                      <!-- Recursively render the same fields -->
                      <ng-container [formGroup]="$any(subcriterion)">
                        <div class="logbook-fields subcriteria-fields">
                          <tui-textfield>
                            <label tuiLabel>Description</label>
                            <input tuiTextfield formControlName="description" type="text" placeholder="Criteria description" />
                          </tui-textfield>

                          <div class="radio-group">
                            <label class="radio-label">Criteria Type:</label>
                            <div class="radio-options">
                              <label class="radio-option">
                                <input type="radio" formControlName="criteriaType" value="universal" />
                                Universal
                              </label>
                              <label class="radio-option">
                                <input type="radio" formControlName="criteriaType" value="tag-based" />
                                Tag-Based
                              </label>
                              <label class="radio-option">
                                <input type="radio" formControlName="criteriaType" value="criteria-based" />
                                Criteria-Based
                              </label>
                            </div>
                          </div>

                          <!-- Tag-Based Fields for Subcriterion -->
                          @if (subcriterion.get('criteriaType')?.value === 'tag-based') {
                            <div class="select-field">
                              <label class="select-label">Type</label>
                              <select class="tui-select" formControlName="type">
                                <option value="">Select type...</option>
                                @for (typeOption of tagBasedCriterionTypes; track typeOption) {
                                  <option [value]="typeOption">{{ typeOption }}</option>
                                }
                              </select>
                            </div>

                            <tui-textfield>
                              <label tuiLabel>Tags (comma-separated)</label>
                              <input tuiTextfield formControlName="tags" type="text" placeholder="Tag1, Tag2" />
                            </tui-textfield>
                          }

                          <!-- Criteria-Based Fields for Subcriterion -->
                          @if (subcriterion.get('criteriaType')?.value === 'criteria-based') {
                            <tui-textfield>
                              <label tuiLabel>Criteria Expression</label>
                              <textarea tuiTextarea formControlName="criteria" rows="2" placeholder="e.g., o => o.Amount.Amount > 0"></textarea>
                            </tui-textfield>
                          }

                          <!-- Substitution for Subcriterion -->
                          @if (subcriterion.get('criteriaType')?.value !== 'universal') {
                            <tui-textfield>
                              <label tuiLabel>Substitution (Optional)</label>
                              <textarea tuiTextarea formControlName="substitution" rows="2" placeholder="e.g., o => o.Description"></textarea>
                            </tui-textfield>
                          }

                          <!-- Nested Subcriteria (recursive) -->
                          <div class="nested-subcriteria">
                            <h5>Nested Subcriteria</h5>
                            <button 
                              tuiButton
                              type="button"
                              appearance="flat"
                              size="xs"
                              (click)="addSubcriterion($any(subcriterion))">
                              + Add Nested Subcriterion
                            </button>
                            
                            @for (nestedSub of getSubcriteria($any(subcriterion)).controls; track $index; let nestedIdx = $index) {
                              <div class="nested-subcriterion-card">
                                <ng-container [formGroup]="$any(nestedSub)">
                                <div class="subcriterion-header">
                                  <span>Nested {{ nestedIdx + 1 }}</span>
                                  <button 
                                    tuiButton
                                    type="button"
                                    appearance="flat"
                                    size="xs"
                                    (click)="removeSubcriterion($any(subcriterion), nestedIdx)">
                                    Remove
                                  </button>
                                </div>
                                
                                <!-- Third level nesting -->
                                <div class="logbook-fields nested-fields">
                                  <tui-textfield>
                                    <label tuiLabel>Description</label>
                                    <input tuiTextfield formControlName="description" type="text" />
                                  </tui-textfield>

                                  <div class="radio-group">
                                    <label class="radio-label">Type:</label>
                                    <div class="radio-options">
                                      <label class="radio-option">
                                        <input type="radio" formControlName="criteriaType" value="universal" />
                                        Universal
                                      </label>
                                      <label class="radio-option">
                                        <input type="radio" formControlName="criteriaType" value="tag-based" />
                                        Tag-Based
                                      </label>
                                      <label class="radio-option">
                                        <input type="radio" formControlName="criteriaType" value="criteria-based" />
                                        Criteria-Based
                                      </label>
                                    </div>
                                  </div>

                                  @if (nestedSub.get('criteriaType')?.value === 'tag-based') {
                                    <div class="select-field">
                                      <label class="select-label">Type</label>
                                      <select class="tui-select" formControlName="type">
                                        <option value="">Select type...</option>
                                        @for (typeOption of tagBasedCriterionTypes; track typeOption) {
                                          <option [value]="typeOption">{{ typeOption }}</option>
                                        }
                                      </select>
                                    </div>
                                    <tui-textfield>
                                      <label tuiLabel>Tags</label>
                                      <input tuiTextfield formControlName="tags" type="text" />
                                    </tui-textfield>
                                  }

                                  @if (nestedSub.get('criteriaType')?.value === 'criteria-based') {
                                    <tui-textfield>
                                      <label tuiLabel>Criteria</label>
                                      <textarea tuiTextarea formControlName="criteria" rows="2"></textarea>
                                    </tui-textfield>
                                  }

                                  @if (nestedSub.get('criteriaType')?.value !== 'universal') {
                                    <tui-textfield>
                                      <label tuiLabel>Substitution</label>
                                      <textarea tuiTextarea formControlName="substitution" rows="1"></textarea>
                                    </tui-textfield>
                                  }
                                  
                                  <p class="nesting-note"><em>Note: Further nesting beyond this level is not supported in the UI.</em></p>
                                </div>
                                </ng-container>
                              </div>
                            }
                          </div>
                        </div>
                      </ng-container>
                    </div>
                  }
                </div>
              </div>
            </div>

            <!-- Form Actions -->
            <div class="form-actions">
              <button 
                tuiButton
                type="button"
                appearance="primary"
                size="m"
                [disabled]="!budgetForm.valid || isLoading"
                (click)="saveBudget()">
                Save Changes
              </button>
              <button 
                tuiButton
                type="button"
                appearance="flat"
                size="m"
                (click)="toggleEditMode()">
                Cancel
              </button>
            </div>
          </form>
        } @else {
          <!-- Read-only view -->
          <div class="read-only-view">
            <!-- Tagging Criteria Display -->
            @if (budget.taggingCriteria.length > 0) {
              <div class="criteria-section">
                <h3 tuiTitle size="m">Tagging Criteria</h3>
                @for (criterion of budget.taggingCriteria; track $index) {
                  <div class="criterion-card">
                    <div class="criterion-row">
                      <span class="criterion-label">Tag:</span>
                      <code class="criterion-value">{{ criterion.tag }}</code>
                    </div>
                    <div class="criterion-row">
                      <span class="criterion-label">Condition:</span>
                      <code class="criterion-value">{{ criterion.condition }}</code>
                    </div>
                  </div>
                }
              </div>
            }

            <!-- Transfer Criteria Display -->
            @if (budget.transferCriteria.length > 0) {
              <div class="criteria-section">
                <h3 tuiTitle size="m">Transfer Criteria</h3>
                @for (criterion of budget.transferCriteria; track $index) {
                  <div class="criterion-card">
                    <div class="criterion-row">
                      <span class="criterion-label">Accuracy:</span>
                      <tui-chip size="s">{{ criterion.accuracy }}</tui-chip>
                    </div>
                    <div class="criterion-row">
                      <span class="criterion-label">Comment:</span>
                      <span class="criterion-value">{{ criterion.comment }}</span>
                    </div>
                    <div class="criterion-row">
                      <span class="criterion-label">Criterion:</span>
                      <code class="criterion-value">{{ criterion.criterion }}</code>
                    </div>
                  </div>
                }
              </div>
            }

            <!-- Logbook Criteria Display -->
            <div class="criteria-section">
              <h3 tuiTitle size="m">Logbook Criteria</h3>
              @if (budget.logbookCriteria) {
                <ng-container *ngTemplateOutlet="logbookCriteriaTemplate; context: { $implicit: budget.logbookCriteria, level: 0 }"></ng-container>
              }
            </div>
          </div>
        }
      </div>
    </tui-loader>
  } @else {
    <tui-loader [showLoader]="true">
      <div class="loading-placeholder">Loading budget...</div>
    </tui-loader>
  }
</div>

<!-- Recursive template for displaying logbook criteria -->
<ng-template #logbookCriteriaTemplate let-criteria let-level="level">
  <div class="criterion-card" [style.margin-left.rem]="level * 2">
    <div class="criterion-row">
      <span class="criterion-label">Description:</span>
      <span class="criterion-value">{{ criteria.description || 'N/A' }}</span>
    </div>
    @if (criteria.isUniversal) {
      <tui-chip size="m">Universal</tui-chip>
    }
    @if (criteria.type) {
      <div class="criterion-row">
        <span class="criterion-label">Type:</span>
        <tui-chip size="s">{{ criteria.type }}</tui-chip>
      </div>
    }
    @if (criteria.tags && criteria.tags.length > 0) {
      <div class="criterion-row">
        <span class="criterion-label">Tags:</span>
        <div class="tags-list">
          @for (tag of criteria.tags; track tag) {
            <tui-chip size="s">{{ tag }}</tui-chip>
          }
        </div>
      </div>
    }
    @if (criteria.criteria) {
      <div class="criterion-row">
        <span class="criterion-label">Criteria:</span>
        <code class="criterion-value">{{ criteria.criteria }}</code>
      </div>
    }
    @if (criteria.substitution) {
      <div class="criterion-row">
        <span class="criterion-label">Substitution:</span>
        <code class="criterion-value">{{ criteria.substitution }}</code>
      </div>
    }
    
    <!-- Recursively display subcriteria -->
    @if (criteria.subcriteria && criteria.subcriteria.length > 0) {
      <div class="subcriteria-display">
        <h4 class="subcriteria-title">Subcriteria:</h4>
        @for (sub of criteria.subcriteria; track $index) {
          <ng-container *ngTemplateOutlet="logbookCriteriaTemplate; context: { $implicit: sub, level: level + 1 }"></ng-container>
        }
      </div>
    }
  </div>
</ng-template>

