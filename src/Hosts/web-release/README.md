# Budget Application - Production Release

This directory contains the production-ready Docker Compose configuration for the Budget application with HTTPS support, automatic database backups, and proper service orchestration.

## Services Overview

- **budget-client** - Angular client application (served by Kestrel with HTTPS)
- **budget-server** - ASP.NET Core API server (Kestrel with HTTPS)
- **postgres** - PostgreSQL 17 database
- **pgbackups** - Automated database backup service
- **cert-generator** - Self-signed SSL certificate generator (uses [nvs-certgen](https://github.com/nvsnkv/certgen))

## Prerequisites

- Docker and Docker Compose installed
- Access to Docker registry with the budget images
- Yandex OAuth credentials (for authentication)

## Quick Start

### 1. Setup Environment Variables

Copy the example environment file and configure it:

```bash
cp .env.example .env
```

Edit `.env` and configure the following **required** variables:

```env
# Database password (change this!)
POSTGRES_PASSWORD=your_secure_password_here

# Backup location (absolute path)
BACKUP_PATH=/path/to/your/backups

# SSL certificate hostname
CERT_HOSTNAME=budget.yourdomain.com

# Docker registry details
DOCKER_REGISTRY=docker.io
DOCKER_NAMESPACE=yournamespace
IMAGE_VERSION=latest

# Yandex OAuth credentials
YANDEX_OAUTH_CLIENT_ID=your_yandex_client_id
YANDEX_OAUTH_CLIENT_SECRET=your_yandex_client_secret
```

### 2. Pull or Build Images

If you need to build the images first:

```bash
# Navigate to the Hosts directory
cd ../

# Build and push images using the release script
.\Release-DockerImages.ps1 -Version "1.0.0"

# Or just build locally
.\Release-DockerImages.ps1 -Version "1.0.0" -SkipPush
```

If images are already in your registry, they will be pulled automatically.

### 3. Start the Application

```bash
docker-compose up -d
```

This will:
1. Create the network and volumes
2. Start PostgreSQL database
3. Generate self-signed SSL certificates
4. Start the budget-client (Kestrel with HTTPS)
5. Start the budget-server (Kestrel with HTTPS)
6. Start the backup service

### 4. Access the Application

- **Client (Frontend)**: `https://localhost:25000` (or your configured `https://CERT_HOSTNAME:CLIENT_PORT`)
- **Server (API)**: `https://localhost:25001` (or your configured `https://CERT_HOSTNAME:SERVER_PORT`)

**Note**: Since we're using self-signed certificates, you'll need to accept the security warning in your browser.

Both services use HTTPS directly with Kestrel and share the same SSL certificates.

## Configuration Details

### Port Configuration

The application exposes two HTTPS ports (configurable via `.env`):

- `CLIENT_PORT` (default: 25000) - Client application HTTPS port
- `SERVER_PORT` (default: 25001) - Server API HTTPS port

**Note**: The frontend URL is automatically constructed as `https://${CERT_HOSTNAME}:${CLIENT_PORT}` and passed to the budget-server for CORS and OAuth redirects.

### Architecture

Both the client and server use Kestrel with HTTPS enabled:

- **Client**: Kestrel serves the Angular application over HTTPS on `CLIENT_PORT`
- **Server**: Kestrel serves the API over HTTPS on `SERVER_PORT`
- **SSL Certificates**: Both services share the same SSL certificates generated by cert-generator
- **Runtime Configuration**: The Angular app loads its API URL dynamically from `/api/config` endpoint, allowing the same client image to work in different environments

This provides a uniform architecture where both services are ASP.NET Core applications using the same web server (Kestrel) with identical HTTPS configuration.

#### Runtime Configuration

The client application uses runtime configuration instead of build-time configuration:

1. On startup, the Angular app calls `/api/config` endpoint
2. The ASP.NET Core server returns the API URL from environment variables
3. The `APP_INITIALIZER` sets the API URL before the app starts
4. This allows the same Docker image to be deployed in different environments without rebuilding

### Database Backups

The `pgbackups` service automatically backs up the PostgreSQL database:

- **Schedule**: Daily by default (configurable via `BACKUP_SCHEDULE`)
- **Retention**: 
  - Daily backups: 7 days
  - Weekly backups: 4 weeks
  - Monthly backups: 6 months
- **Location**: Specified by `BACKUP_PATH` in `.env`

**Important**: Ensure the backup path exists and has proper permissions:

```bash
# Linux/Mac
mkdir -p /path/to/your/backups
chmod 755 /path/to/your/backups

# Windows
New-Item -Path "C:\backups\budget" -ItemType Directory -Force
```

### SSL Certificates

The application uses [nvs-certgen](https://github.com/nvsnkv/certgen) to automatically generate self-signed SSL certificates on first run. The certificate is valid for 365 days by default (configurable via `CERT_DAYS`).

Certificate files:
- `tls.crt` - Certificate file
- `tls.key` - Private key

For production use with real domain names, you should:

1. **Option A**: Use Let's Encrypt with Certbot
2. **Option B**: Replace the `cert-generator` service with your own certificates:

```yaml
# Mount your own certificates (must be named tls.crt and tls.key)
budget-client:
  volumes:
    - ./my-certs:/certs:ro

budget-server:
  volumes:
    - ./my-certs:/certs:ro
```

**Note**: If you need to regenerate certificates (e.g., after hostname change or expiration), remove the certs volume:

```bash
docker-compose down
docker volume rm web-release_certs
docker-compose up -d
```

## Management Commands

### View Logs

```bash
# All services
docker-compose logs -f

# Specific service
docker-compose logs -f budget-server
docker-compose logs -f budget-client
docker-compose logs -f pgbackups
```

### Stop Application

```bash
docker-compose down
```

### Stop and Remove Data

```bash
# Warning: This will delete all data including database!
docker-compose down -v
```

### Restart a Service

```bash
docker-compose restart budget-server
```

### Update to New Version

```bash
# Update .env with new version
# IMAGE_VERSION=1.0.1

# Pull new images and restart
docker-compose pull
docker-compose up -d
```

### Check Service Health

```bash
docker-compose ps
```

## Backup and Restore

### Manual Backup

```bash
docker-compose exec postgres pg_dump -U postgres budgetdb > backup.sql
```

### Restore from Backup

```bash
# Stop the application
docker-compose down

# Remove old database volume
docker volume rm web-release_postgres-data

# Start only postgres
docker-compose up -d postgres

# Wait for postgres to be ready (check logs)
docker-compose logs -f postgres

# Restore backup
cat backup.sql | docker-compose exec -T postgres psql -U postgres budgetdb

# Start all services
docker-compose up -d
```

### Access Automated Backups

Backups are stored in the directory specified by `BACKUP_PATH`:

```bash
# List backups
ls -lah /path/to/your/backups

# Backups are named: daily/budgetdb-YYYYMMDD-HHMMSS.sql.gz
```

## Troubleshooting

### Cannot Connect to Application

1. Check all services are running:
   ```bash
   docker-compose ps
   ```

2. Check client logs:
   ```bash
   docker-compose logs budget-client
   ```

3. Check server logs:
   ```bash
   docker-compose logs budget-server
   ```

4. Verify certificates were generated:
   ```bash
   docker-compose logs cert-generator
   ```

### Database Connection Issues

1. Check postgres is healthy:
   ```bash
   docker-compose ps postgres
   ```

2. Check server logs:
   ```bash
   docker-compose logs budget-server
   ```

3. Verify database credentials in `.env`

### OAuth Authentication Issues

1. Verify Yandex OAuth credentials in `.env`
2. Check that the redirect URI is configured in Yandex OAuth settings
3. Check server logs for authentication errors

### Backup Issues

1. Verify `BACKUP_PATH` exists and is accessible:
   ```bash
   # Linux/Mac
   ls -ld /path/to/your/backups
   
   # Windows
   Test-Path "C:\backups\budget"
   ```

2. Check backup service logs:
   ```bash
   docker-compose logs pgbackups
   ```

### Certificate Issues

If you encounter certificate issues or need to regenerate certificates:

1. Check cert-generator logs:
   ```bash
   docker-compose logs cert-generator
   ```

2. Regenerate certificates:
   ```bash
   # Remove the certs volume
   docker-compose down
   docker volume rm web-release_certs

   # Restart (will regenerate certificates)
   docker-compose up -d
   ```

3. Verify hostname configuration in `.env` matches your domain

## Production Recommendations

1. **Use Real SSL Certificates**: Replace self-signed certificates with proper SSL certificates from Let's Encrypt or a certificate authority

2. **Secure Database Password**: Use a strong, randomly generated password for PostgreSQL

3. **Regular Backups**: Monitor the backup service and test restores regularly

4. **Resource Limits**: Add resource limits to services in docker-compose.yml:
   ```yaml
   deploy:
     resources:
       limits:
         cpus: '1'
         memory: 1G
   ```

5. **Monitoring**: Consider adding monitoring services (Prometheus, Grafana)

6. **Reverse Proxy**: If running on a server, consider using a proper reverse proxy like Traefik or Caddy for automatic HTTPS with Let's Encrypt

7. **Firewall**: Ensure only necessary ports are exposed to the internet

8. **Updates**: Regularly update Docker images and apply security patches

## Environment Variables Reference

| Variable | Description | Default | Required |
|----------|-------------|---------|----------|
| `POSTGRES_DB` | Database name | budgetdb | No |
| `POSTGRES_USER` | Database user | postgres | No |
| `POSTGRES_PASSWORD` | Database password | - | **Yes** |
| `BACKUP_PATH` | Path for database backups | - | **Yes** |
| `BACKUP_SCHEDULE` | Cron schedule for backups | @daily | No |
| `BACKUP_KEEP_DAYS` | Days to keep daily backups | 7 | No |
| `BACKUP_KEEP_WEEKS` | Weeks to keep weekly backups | 4 | No |
| `BACKUP_KEEP_MONTHS` | Months to keep monthly backups | 6 | No |
| `CERT_HOSTNAME` | SSL certificate hostname | localhost | No |
| `CERT_DAYS` | Certificate validity in days | 365 | No |
| `CERTGEN_VERSION` | nvs-certgen image version | latest | No |
| `DOCKER_REGISTRY` | Docker registry URL (used for all images) | docker.io | **Yes** |
| `DOCKER_NAMESPACE` | Docker namespace/username | - | **Yes** |
| `IMAGE_VERSION` | Image version tag | latest | No |
| `CLIENT_PORT` | Client HTTPS port | 25000 | No |
| `SERVER_PORT` | Server HTTPS port | 25001 | No |
| `ApiUrl` | API URL passed to client (auto-constructed) | https://${CERT_HOSTNAME}:${SERVER_PORT} | No |
| `YANDEX_OAUTH_CLIENT_ID` | Yandex OAuth client ID | - | **Yes** |
| `YANDEX_OAUTH_CLIENT_SECRET` | Yandex OAuth client secret | - | **Yes** |

## Support

For issues or questions, please refer to the main project documentation or contact the development team.
