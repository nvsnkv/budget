services:
  postgres:
    image: postgres:17
    container_name: budget-postgres
    restart: unless-stopped
    environment:
      POSTGRES_DB: ${POSTGRES_DB:-budgetdb}
      POSTGRES_USER: ${POSTGRES_USER:-postgres}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      PGDATA: /var/lib/postgresql/data/pgdata
    volumes:
      - postgres-data:/var/lib/postgresql/data
    networks:
      - budget-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-postgres}"]
      interval: 10s
      timeout: 5s
      retries: 5

  pgbackups:
    image: prodrigestivill/postgres-backup-local:17
    container_name: budget-pgbackups
    restart: unless-stopped
    environment:
      POSTGRES_HOST: postgres
      POSTGRES_DB: ${POSTGRES_DB:-budgetdb}
      POSTGRES_USER: ${POSTGRES_USER:-postgres}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      SCHEDULE: ${BACKUP_SCHEDULE:-@daily}
      BACKUP_KEEP_DAYS: ${BACKUP_KEEP_DAYS:-7}
      BACKUP_KEEP_WEEKS: ${BACKUP_KEEP_WEEKS:-4}
      BACKUP_KEEP_MONTHS: ${BACKUP_KEEP_MONTHS:-6}
      HEALTHCHECK_PORT: 8080
    volumes:
      - ${BACKUP_PATH}:/backups
    networks:
      - budget-network
    depends_on:
      postgres:
        condition: service_healthy

  cert-generator:
    image: ${DOCKER_REGISTRY}/nvsnkv/certgen:${CERTGEN_VERSION:-latest}
    container_name: budget-cert-generator
    environment:
      CERT_HOSTNAME: ${CERT_HOSTNAME:-localhost}
      CERT_DIR: /certs
      CERT_FILE: tls.crt
      KEY_FILE: tls.key
      CERT_DAYS: ${CERT_DAYS:-365}
    volumes:
      - certs:/certs
    networks:
      - budget-network

  budget-server:
    image: ${DOCKER_REGISTRY}/${DOCKER_NAMESPACE}/budget-server:${IMAGE_VERSION:-latest}
    container_name: budget-server
    restart: unless-stopped
    environment:
      ASPNETCORE_ENVIRONMENT: Production
      ASPNETCORE_URLS: http://+:8080
      ConnectionStrings__DefaultConnection: Host=postgres;Database=${POSTGRES_DB:-budgetdb};Username=${POSTGRES_USER:-postgres};Password=${POSTGRES_PASSWORD}
      Auth__Yandex__ClientId: ${YANDEX_OAUTH_CLIENT_ID}
      Auth__Yandex__ClientSecret: ${YANDEX_OAUTH_CLIENT_SECRET}
      FrontendUrl: https://${CERT_HOSTNAME:-localhost}:${NGINX_PORT:-25000}
    networks:
      - budget-network
    depends_on:
      postgres:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8080/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  budget-client:
    image: ${DOCKER_REGISTRY}/${DOCKER_NAMESPACE}/budget-client:${IMAGE_VERSION:-latest}
    container_name: budget-client
    restart: unless-stopped
    environment:
      ASPNETCORE_ENVIRONMENT: Production
      ASPNETCORE_URLS: http://+:8080
    networks:
      - budget-network
    depends_on:
      - budget-server
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8080 || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s

  nginx:
    image: nginx:alpine
    container_name: budget-nginx
    restart: unless-stopped
    ports:
      - "${NGINX_PORT:-25000}:443"
      - "${NGINX_HTTP_PORT:-25001}:80"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
      - certs:/etc/nginx/certs:ro
    networks:
      - budget-network
    depends_on:
      cert-generator:
        condition: service_completed_successfully
      budget-server:
        condition: service_healthy
      budget-client:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:80/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3

networks:
  budget-network:
    driver: bridge

volumes:
  postgres-data:
  certs:
